# 基金切换性能优化 - 测试指南

## 如何验证优化效果

### 准备工作
1. 确保后端服务正在运行
2. 确保 Redis 服务正在运行
3. 打开浏览器开发者工具（F12）的 Console 和 Network 标签

### 测试步骤

#### 测试 1: 验证客户端缓存
1. 访问基金页面 `/funds`
2. 在关注列表中选择第一个基金（例如：022365）
3. 等待数据加载完成
4. 切换到第二个基金（例如：020840）
5. 等待数据加载完成
6. **切换回第一个基金（022365）**

**预期结果**:
- Console 中应该看到: `[Cache Hit] Using cached data for 022365`
- 数据应该**立即显示**，无需等待
- Network 标签中**不应该**有新的 API 请求

#### 测试 2: 验证缓存过期
1. 选择一个基金并等待数据加载
2. 等待 **3 分钟以上**
3. 切换到另一个基金，再切换回来

**预期结果**:
- Console 中**不会**显示 `[Cache Hit]`
- Network 标签中会有新的 API 请求
- 数据会重新加载

#### 测试 3: 验证手动刷新
1. 选择一个基金并等待数据加载
2. 点击右上角的刷新按钮（RefreshCw 图标）

**预期结果**:
- 刷新按钮会显示旋转动画
- Network 标签中会有新的 API 请求
- 数据会更新，`lastUpdated` 时间会改变

#### 测试 4: 验证后端 Redis 缓存
1. 打开两个浏览器标签页，都访问基金页面
2. 在第一个标签页选择基金 022365
3. 等待数据加载完成
4. **立即**在第二个标签页选择同一个基金 022365

**预期结果**:
- 第二个标签页的数据应该**很快**加载（< 500ms）
- 后端日志应该显示: `⚡️ Using cached valuation for 022365`

### 性能对比

#### 优化前
- 首次加载: ~2000ms
- 切换基金: ~2000ms（每次都需要重新计算）
- API 调用频率: 每 60 秒一次

#### 优化后
- 首次加载: ~2000ms（无变化）
- 切换基金（缓存命中）: **< 10ms** ⚡️
- 切换基金（缓存未命中）: ~500ms（Redis 缓存命中）
- API 调用频率: 每 180 秒一次

### 监控指标

#### 浏览器 Console
```
[Cache Hit] Using cached data for 022365  // 客户端缓存命中
```

#### 后端日志
```
⚡️ Using cached valuation for 022365     // Redis 缓存命中
📈 Calculating valuation for 022365       // 缓存未命中，重新计算
```

#### Network 标签
- 查看 `/api/funds/{code}/valuation` 请求的频率
- 优化后应该显著减少

### 故障排查

#### 问题 1: 缓存没有生效
**检查**:
1. 浏览器 Console 是否有错误
2. Redis 服务是否正常运行
3. 环境变量 `REDIS_URL` 是否正确配置

#### 问题 2: 数据不更新
**解决**:
1. 点击手动刷新按钮
2. 等待 3 分钟让缓存自动过期
3. 刷新整个页面

#### 问题 3: 切换仍然很慢
**检查**:
1. Network 标签中是否有其他慢速请求
2. 后端日志是否显示 Redis 缓存命中
3. 是否在 3 分钟缓存期内

### 建议的监控方式

#### 开发环境
```bash
# 监控 Redis 缓存
redis-cli MONITOR | grep "fund:valuation"

# 查看后端日志
tail -f logs/app.log | grep -E "Cache|Calculating"
```

#### 生产环境
- 使用 APM 工具监控 API 响应时间
- 监控 Redis 缓存命中率
- 设置性能阈值告警

## 预期性能提升

### 用户体验
- ✅ 关注列表切换速度提升 **99%**（从 2s 降至 < 10ms）
- ✅ 减少等待时间，提升用户满意度
- ✅ 降低服务器负载

### 技术指标
- ✅ API 调用减少 **66%**（从每分钟到每 3 分钟）
- ✅ 后端计算减少 **80%+**（多数请求由 Redis 缓存处理）
- ✅ 外部 API（yfinance）调用减少 **80%+**
